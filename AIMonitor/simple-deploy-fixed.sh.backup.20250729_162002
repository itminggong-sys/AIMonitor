#!/bin/bash

# =============================================================================
# AI Monitor ä¸€é”®éƒ¨ç½²è„šæœ¬ - å®Œæ•´ç‰ˆæœ¬
# ç‰ˆæœ¬: 3.8.5
# æè¿°: æ™ºèƒ½æ£€æµ‹é¡¹ç›®ç»“æ„ï¼Œä½¿ç”¨ç°æœ‰å®Œæ•´é¡¹ç›®æˆ–åˆ›å»ºæ–°çš„å®Œæ•´é¡¹ç›®ç»“æ„
# ä¿®å¤: docker-compose.ymlé…ç½®ä¸å®Œæ•´é—®é¢˜
# v3.8.5 æ–°å¢åŠŸèƒ½ï¼š
# - ä¿®å¤docker-compose.ymlç¼ºå°‘aimonitorå’ŒfrontendæœåŠ¡é…ç½®
# - ç»Ÿä¸€æ‰€æœ‰æœåŠ¡çš„ç½‘ç»œé…ç½®ï¼Œç¡®ä¿æœåŠ¡é—´æ­£å¸¸é€šä¿¡
# - ä¼˜åŒ–Docker Composeå…¼å®¹æ€§ï¼Œç§»é™¤è¿‡æ—¶çš„versionå­—æ®µ
# - ä¼˜åŒ–æ‰€æœ‰Dockerfileæ¨¡æ¿çš„Goæ¨¡å—å¤„ç†é€»è¾‘
# - å®Œå–„æ¼”ç¤ºé¡¹ç›®æ¨¡å¼ä¸‹çš„å‰ç«¯æ„å»ºé…ç½®
# - æå‡CentOSç¯å¢ƒä¸‹çš„éƒ¨ç½²æˆåŠŸç‡
# =============================================================================

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é¡¹ç›®ä¿¡æ¯
PROJECT_NAME="AIMonitor"
PROJECT_DIR="$HOME/$PROJECT_NAME"
LOG_FILE="$PROJECT_DIR/deploy.log"

# è·å–å½“å‰æ—¶é—´çš„å‡½æ•°
get_timestamp() {
    date '+%Y-%m-%d %H:%M:%S'
}

# åˆ›å»ºæ—¥å¿—å‡½æ•°
log() {
    local timestamp=$(get_timestamp)
    if [[ -f "$LOG_FILE" ]] && [[ -w "$(dirname "$LOG_FILE")" ]]; then
        echo "[$timestamp] $1" | tee -a "$LOG_FILE"
    else
        echo "[$timestamp] $1"
    fi
}

log_success() {
    local timestamp=$(get_timestamp)
    if [[ -f "$LOG_FILE" ]] && [[ -w "$(dirname "$LOG_FILE")" ]]; then
        echo -e "${GREEN}âœ… [$timestamp] $1${NC}" | tee -a "$LOG_FILE"
    else
        echo -e "${GREEN}âœ… [$timestamp] $1${NC}"
    fi
}

log_error() {
    local timestamp=$(get_timestamp)
    if [[ -f "$LOG_FILE" ]] && [[ -w "$(dirname "$LOG_FILE")" ]]; then
        echo -e "${RED}âŒ [$timestamp] $1${NC}" | tee -a "$LOG_FILE"
    else
        echo -e "${RED}âŒ [$timestamp] $1${NC}"
    fi
}

log_warning() {
    local timestamp=$(get_timestamp)
    if [[ -f "$LOG_FILE" ]] && [[ -w "$(dirname "$LOG_FILE")" ]]; then
        echo -e "${YELLOW}âš ï¸  [$timestamp] $1${NC}" | tee -a "$LOG_FILE"
    else
        echo -e "${YELLOW}âš ï¸  [$timestamp] $1${NC}"
    fi
}

log_info() {
    local timestamp=$(get_timestamp)
    if [[ -f "$LOG_FILE" ]] && [[ -w "$(dirname "$LOG_FILE")" ]]; then
        echo -e "${BLUE}â„¹ï¸  [$timestamp] $1${NC}" | tee -a "$LOG_FILE"
    else
        echo -e "${BLUE}â„¹ï¸  [$timestamp] $1${NC}"
    fi
}

# æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
show_welcome() {
    clear
    echo -e "${BLUE}"
    echo "    ___    ____   __  ___            _ __            "
    echo "   /   |  /  _/  /  |/  /___  ____  (_) /_____  _____"
    echo "  / /| |  / /   / /|_/ / __ \/ __ \/ / __/ __ \/ ___/"
    echo " / ___ |_/ /   / /  / / /_/ / / / / / /_/ /_/ / /    "
    echo "/_/  |_/___/  /_/  /_/\____/_/ /_/_/\__/\____/_/     "
    echo -e "${NC}"
    echo -e "${GREEN}ğŸš€ AI Monitor æ™ºèƒ½ç›‘æ§ç³»ç»Ÿ - å®Œæ•´ç‰ˆä¸€é”®éƒ¨ç½²${NC}"
    echo -e "${BLUE}ğŸ“§ æŠ€æœ¯æ”¯æŒ: support@ai-monitor.com${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ¯ æœ¬è„šæœ¬å°†ä¸ºæ‚¨è‡ªåŠ¨å®Œæˆä»¥ä¸‹æ“ä½œ:${NC}"
    echo "   1. æ£€æŸ¥å¹¶å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–"
    echo "   2. è‡ªåŠ¨é…ç½®Dockerç¯å¢ƒ"
    echo "   3. éƒ¨ç½²å®Œæ•´çš„AI Monitorç³»ç»Ÿ(åŒ…å«å‰ç«¯ç•Œé¢)"
    echo "   4. å¯åŠ¨Prometheusç›‘æ§å’ŒElasticsearchæœç´¢"
    echo "   5. æä¾›è®¿é—®åœ°å€å’Œä½¿ç”¨è¯´æ˜"
    echo ""
    echo -e "${GREEN}ğŸ’¡ æ•´ä¸ªè¿‡ç¨‹å¤§çº¦éœ€è¦10-15åˆ†é’Ÿï¼Œè¯·ä¿æŒç½‘ç»œè¿æ¥${NC}"
    echo ""
    read -p "æŒ‰å›è½¦é”®å¼€å§‹éƒ¨ç½²ï¼Œæˆ–æŒ‰ Ctrl+C å–æ¶ˆ..." -r
    echo ""
}

# åˆ›å»ºé¡¹ç›®ç›®å½•
setup_project_dir() {
    log_info "åˆ›å»ºé¡¹ç›®ç›®å½•: $PROJECT_DIR"
    mkdir -p "$PROJECT_DIR"
    cd "$PROJECT_DIR"
    
    # åˆ›å»ºå­ç›®å½•
    mkdir -p logs data web configs cmd/server
    
    # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å¯ä»¥åˆ›å»º
    mkdir -p "$(dirname "$LOG_FILE")"
    touch "$LOG_FILE" 2>/dev/null || {
        LOG_FILE="/tmp/aimonitor-deploy.log"
        touch "$LOG_FILE"
        log_warning "ä½¿ç”¨ä¸´æ—¶æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    }
    
    log_success "é¡¹ç›®ç›®å½•åˆ›å»ºå®Œæˆ"
}

# æ£€æµ‹æ“ä½œç³»ç»Ÿ
detect_os() {
    log_info "æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹"
    
    # æ£€æŸ¥æ˜¯å¦åœ¨WSLç¯å¢ƒä¸­
    if grep -qi microsoft /proc/version 2>/dev/null; then
        log_info "æ£€æµ‹åˆ°WSLç¯å¢ƒ"
    fi
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºDocker Desktop WSLç¯å¢ƒ
    if [ -f /etc/os-release ] && grep -q "Docker Desktop" /etc/os-release 2>/dev/null; then
        OS="docker-desktop"
        PACKAGE_MANAGER="none"
        log_info "æ£€æµ‹åˆ°Docker Desktop WSLç¯å¢ƒ"
        log_success "æ£€æµ‹åˆ°æ“ä½œç³»ç»Ÿ: $OS (Dockerå·²é¢„è£…)"
        return 0
    fi
    
    # ä¼˜å…ˆæ£€æŸ¥/etc/os-releaseæ–‡ä»¶
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        case "$ID" in
            "centos"|"rhel"|"fedora")
                OS="centos"
                PACKAGE_MANAGER="yum"
                ;;
            "ubuntu"|"debian")
                OS="ubuntu"
                PACKAGE_MANAGER="apt"
                ;;
            *)
                OS="linux"
                PACKAGE_MANAGER="apt"  # é»˜è®¤ä½¿ç”¨apt
                ;;
        esac
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if [ -f /etc/redhat-release ]; then
            OS="centos"
            PACKAGE_MANAGER="yum"
        elif [ -f /etc/debian_version ]; then
            OS="ubuntu"
            PACKAGE_MANAGER="apt"
        else
            OS="linux"
            PACKAGE_MANAGER="apt"  # é»˜è®¤ä½¿ç”¨apt
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        OS="macos"
        PACKAGE_MANAGER="brew"
    else
        # å¦‚æœæ— æ³•æ£€æµ‹ï¼Œé»˜è®¤ä¸ºubuntu
        OS="ubuntu"
        PACKAGE_MANAGER="apt"
        log_warning "æ— æ³•å‡†ç¡®æ£€æµ‹æ“ä½œç³»ç»Ÿï¼Œé»˜è®¤ä½¿ç”¨Ubuntué…ç½®"
    fi
    
    log_success "æ£€æµ‹åˆ°æ“ä½œç³»ç»Ÿ: $OS (åŒ…ç®¡ç†å™¨: $PACKAGE_MANAGER)"
}

# æ£€æŸ¥sudoå‘½ä»¤æ˜¯å¦å¯ç”¨
check_sudo() {
    if command -v sudo &> /dev/null && [ "$(id -u)" != "0" ]; then
        echo "sudo"
    else
        echo ""
    fi
}

# æ£€æŸ¥å¹¶å®‰è£…Docker
install_docker() {
    log_info "æ£€æŸ¥Dockerå®‰è£…çŠ¶æ€"
    local SUDO_CMD=$(check_sudo)
    
    # Docker Desktop WSLç¯å¢ƒç‰¹æ®Šå¤„ç†
    if [ "$OS" = "docker-desktop" ]; then
        if command -v docker &> /dev/null; then
            log_success "Docker Desktopç¯å¢ƒï¼ŒDockerå·²é¢„è£…"
            if docker ps &> /dev/null; then
                log_success "DockeræœåŠ¡æ­£å¸¸è¿è¡Œ"
                return 0
            else
                log_warning "DockeræœåŠ¡æœªå¯åŠ¨ï¼Œè¯·ç¡®ä¿Docker Desktopæ­£åœ¨è¿è¡Œ"
                log_info "è¯·åœ¨Windowsä¸­å¯åŠ¨Docker Desktopåº”ç”¨ç¨‹åº"
                return 1
            fi
        else
            log_error "Docker Desktopç¯å¢ƒä¸­æœªæ‰¾åˆ°Dockerå‘½ä»¤"
            return 1
        fi
    fi
    
    if command -v docker &> /dev/null; then
        log_success "Dockerå·²å®‰è£…"
        if docker ps &> /dev/null; then
            log_success "DockeræœåŠ¡æ­£å¸¸è¿è¡Œ"
            return 0
        else
            log_warning "Dockerå·²å®‰è£…ä½†æœåŠ¡æœªå¯åŠ¨ï¼Œå°è¯•å¯åŠ¨..."
            $SUDO_CMD systemctl start docker 2>/dev/null || $SUDO_CMD service docker start 2>/dev/null || true
            sleep 3
            if docker ps &> /dev/null; then
                log_success "DockeræœåŠ¡å¯åŠ¨æˆåŠŸ"
                return 0
            fi
        fi
    fi
    
    log_info "å¼€å§‹å®‰è£…Docker..."
    
    case $OS in
        "centos")
            $SUDO_CMD yum update -y
            $SUDO_CMD yum install -y yum-utils device-mapper-persistent-data lvm2
            $SUDO_CMD yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
            $SUDO_CMD yum install -y docker-ce docker-ce-cli containerd.io
            $SUDO_CMD systemctl start docker
            $SUDO_CMD systemctl enable docker
            ;;
        "ubuntu"|"linux")
            $SUDO_CMD apt update -y
            $SUDO_CMD apt install -y apt-transport-https ca-certificates curl gnupg lsb-release
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | $SUDO_CMD gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg 2>/dev/null || true
            echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs 2>/dev/null || echo focal) stable" | $SUDO_CMD tee /etc/apt/sources.list.d/docker.list > /dev/null
            $SUDO_CMD apt update -y
            $SUDO_CMD apt install -y docker-ce docker-ce-cli containerd.io
            $SUDO_CMD systemctl start docker 2>/dev/null || $SUDO_CMD service docker start 2>/dev/null || true
            $SUDO_CMD systemctl enable docker 2>/dev/null || true
            ;;
        "macos")
            if ! command -v brew &> /dev/null; then
                log_error "è¯·å…ˆå®‰è£…Homebrew: https://brew.sh/"
                exit 1
            fi
            brew install --cask docker
            log_warning "è¯·æ‰‹åŠ¨å¯åŠ¨Docker Desktopåº”ç”¨ç¨‹åº"
            read -p "å¯åŠ¨Docker DesktopåæŒ‰å›è½¦ç»§ç»­..." -r
            ;;
        *)
            log_error "ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $OSï¼Œè¯·æ‰‹åŠ¨å®‰è£…Docker"
            exit 1
            ;;
    esac
    
    # æ·»åŠ ç”¨æˆ·åˆ°dockerç»„
    if [ "$OS" != "macos" ] && [ "$(id -u)" != "0" ]; then
        $SUDO_CMD usermod -aG docker $USER 2>/dev/null || true
        log_warning "å·²å°†ç”¨æˆ·æ·»åŠ åˆ°dockerç»„ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç™»å½•"
    fi
    
    # éªŒè¯Dockerå®‰è£…
    sleep 5
    if docker ps &> /dev/null || $SUDO_CMD docker ps &> /dev/null; then
        log_success "Dockerå®‰è£…å¹¶å¯åŠ¨æˆåŠŸ"
    else
        log_error "Dockerå®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ"
        exit 1
    fi
}

# å®‰è£…Docker Compose
install_docker_compose() {
    log_info "æ£€æŸ¥Docker Composeå®‰è£…çŠ¶æ€"
    local SUDO_CMD=$(check_sudo)
    
    # Docker Desktopç¯å¢ƒé€šå¸¸å·²åŒ…å«docker-compose
    if [ "$OS" = "docker-desktop" ]; then
        if command -v docker-compose &> /dev/null || docker compose version &> /dev/null; then
            log_success "Docker Desktopç¯å¢ƒï¼ŒDocker Composeå·²é¢„è£…"
            return 0
        else
            log_warning "Docker Desktopç¯å¢ƒä¸­æœªæ‰¾åˆ°Docker Compose"
        fi
    fi
    
    if command -v docker-compose &> /dev/null; then
        log_success "Docker Composeå·²å®‰è£…"
        return 0
    fi
    
    log_info "å¼€å§‹å®‰è£…Docker Compose..."
    
    case $OS in
        "centos"|"ubuntu"|"linux")
            $SUDO_CMD curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            $SUDO_CMD chmod +x /usr/local/bin/docker-compose
            ;;
        "macos")
            brew install docker-compose
            ;;
        *)
            log_error "ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $OSï¼Œè¯·æ‰‹åŠ¨å®‰è£…Docker Compose"
            exit 1
            ;;
    esac
    
    if command -v docker-compose &> /dev/null; then
        log_success "Docker Composeå®‰è£…æˆåŠŸ"
    else
        log_error "Docker Composeå®‰è£…å¤±è´¥"
        exit 1
    fi
}

# åˆ›å»ºé¡¹ç›®æ–‡ä»¶
create_project_files() {
    log_info "æ£€æŸ¥é¡¹ç›®ç»“æ„"
    
    # æ£€æŸ¥æ˜¯å¦å­˜åœ¨å®Œæ•´çš„é¡¹ç›®ç»“æ„
    if [ -d "internal" ] && [ -f "cmd/server/main.go" ] && [ -f "go.mod" ]; then
        log_success "æ£€æµ‹åˆ°å®Œæ•´çš„é¡¹ç›®ç»“æ„ï¼Œä½¿ç”¨ç°æœ‰æ–‡ä»¶"
        log_info "é¡¹ç›®æ¨¡å—: $(head -1 go.mod | cut -d' ' -f2)"
        
        # ç¡®ä¿go.sumæ–‡ä»¶å­˜åœ¨ï¼Œé¿å…Dockeræ„å»ºæ—¶çš„"go.sum not found"é”™è¯¯
        if [ ! -f "go.sum" ]; then
            log_info "go.sumæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºçš„go.sumæ–‡ä»¶"
            touch go.sum
            log_success "å·²åˆ›å»ºgo.sumæ–‡ä»¶ï¼ŒDockeræ„å»ºæ—¶ä¼šè‡ªåŠ¨æ›´æ–°"
        else
            log_success "go.sumæ–‡ä»¶å·²å­˜åœ¨"
        fi
        
        # åªåˆ›å»ºå¿…è¦çš„é…ç½®æ–‡ä»¶
        log_info "åˆ›å»ºDockerå’Œé…ç½®æ–‡ä»¶"
        create_docker_configs
        return 0
    fi
    
    log_info "æœªæ£€æµ‹åˆ°å®Œæ•´é¡¹ç›®ç»“æ„ï¼Œåˆ›å»ºå®Œæ•´çš„AI Monitoré¡¹ç›®"
    
    # åˆ›å»ºå®Œæ•´çš„é¡¹ç›®ç›®å½•ç»“æ„
    create_full_project_structure
    
    # åˆ›å»ºDockeré…ç½®æ–‡ä»¶
    create_docker_configs
    
    # åˆ›å»ºå‰ç«¯é¡¹ç›®
    create_frontend
    
    log_success "å®Œæ•´é¡¹ç›®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
}

# åˆ›å»ºDockerå’Œé…ç½®æ–‡ä»¶
create_docker_configs() {
    log_info "åˆ›å»ºDockerå’Œé…ç½®æ–‡ä»¶"
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºå®Œæ•´é¡¹ç›®ç»“æ„
    local is_full_project=false
    if [ -d "internal" ] && [ -f "cmd/server/main.go" ] && [ -f "go.mod" ]; then
        is_full_project=true
        log_info "ä¸ºå®Œæ•´é¡¹ç›®åˆ›å»ºDockeré…ç½®"
    else
        log_info "ä¸ºæ¼”ç¤ºé¡¹ç›®åˆ›å»ºDockeré…ç½®"
    fi
    
    # åˆ›å»ºå®Œæ•´çš„docker-compose.yml
    cat > docker-compose.yml << 'EOF'
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: ai-monitor-postgres
    environment:
      POSTGRES_DB: ai_monitor
      POSTGRES_USER: ai_monitor
      POSTGRES_PASSWORD: password
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ai_monitor -d ai_monitor"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: ai-monitor-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  prometheus:
    image: prom/prometheus:latest
    container_name: ai-monitor-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./configs/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    restart: unless-stopped

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: ai-monitor-elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  aimonitor:
    image: golang:1.21-alpine
    working_dir: /app
    command: sh -c "apk add --no-cache git ca-certificates curl && go env -w GOPROXY=https://goproxy.cn,direct && go env -w GOSUMDB=sum.golang.org && go env -w GO111MODULE=on && echo 'Initializing Go modules...' && ([ ! -f go.sum ] && touch go.sum || true) && echo 'Starting Go module download with retry...' && for i in 1 2 3; do echo \"Attempt $i/3\" && go mod download -x && break || (echo \"Download failed, retrying in 5s...\" && sleep 5); done && echo 'Go modules downloaded successfully' && go mod tidy && echo 'Starting application...' && go run cmd/server/main.go"
    ports:
      - "8080:8080"
    environment:
      - DB_HOST=postgres
      - REDIS_HOST=redis
      - GIN_MODE=release
      - GOPROXY=https://goproxy.cn,direct
      - GOSUMDB=sum.golang.org
      - GO111MODULE=on
      - CGO_ENABLED=0
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - .:/app
      - ./logs:/app/logs
    restart: unless-stopped

  frontend:
    image: node:18-alpine
    working_dir: /app
    command: sh -c "npm config set registry https://registry.npmmirror.com && npm install && npm run dev -- --host 0.0.0.0 --port 3000"
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - VITE_API_BASE_URL=http://localhost:8080
    volumes:
      - ./web:/app
      - /app/node_modules
    restart: unless-stopped
    depends_on:
      aimonitor:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
  redis_data:
  prometheus_data:
  elasticsearch_data:

networks:
  default:
    name: ai-monitor-network
EOF

    # åˆ›å»ºPrometheusé…ç½®
    cat > configs/prometheus.yml << 'EOF'
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'ai-monitor'
    static_configs:
      - targets: ['aimonitor:8080']
    metrics_path: '/metrics'
    scrape_interval: 5s
EOF

    # åªåœ¨æ¼”ç¤ºé¡¹ç›®æ¨¡å¼ä¸‹åˆ›å»ºDockerfile
    if [ "$is_full_project" = false ]; then
        cat > Dockerfile << 'EOF'
FROM golang:1.21-alpine AS builder

WORKDIR /app
COPY go.mod go.sum ./
RUN apk add --no-cache git ca-certificates curl && \
    go env -w GOPROXY=https://goproxy.cn,direct && \
    go env -w GOSUMDB=sum.golang.org && \
    go env -w GO111MODULE=on && \
    ([ ! -f go.sum ] && touch go.sum || true) && \
    for i in 1 2 3; do echo "Go mod download attempt $i/3" && go mod download -x && break || (echo "Download failed, retrying in 5s..." && sleep 5); done

COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main cmd/server/main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/main .
COPY --from=builder /app/configs ./configs
EXPOSE 8080
CMD ["./main"]
EOF
        log_info "Goåç«¯Dockerfileåˆ›å»ºå®Œæˆ"
    else
        log_info "å®Œæ•´é¡¹ç›®æ¨¡å¼ï¼šè·³è¿‡Dockerfileåˆ›å»ºï¼Œä½¿ç”¨ç›´æ¥è¿è¡Œæ–¹å¼"
    fi

    # åˆ›å»ºå‰ç«¯Dockerfile
    mkdir -p web
    cat > web/Dockerfile << 'EOF'
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm config set registry https://registry.npmmirror.com && npm install

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 3000
CMD ["nginx", "-g", "daemon off;"]
EOF

    # åˆ›å»ºnginxé…ç½®
    cat > web/nginx.conf << 'EOF'
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    server {
        listen 3000;
        server_name localhost;
        
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ /index.html;
        }
        
        location /api {
            proxy_pass http://aimonitor:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
EOF

    log_success "Dockerå’Œé…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
}

# åˆ›å»ºå®Œæ•´çš„é¡¹ç›®ç»“æ„
create_full_project_structure() {
    log_info "åˆ›å»ºå®Œæ•´çš„AI Monitoré¡¹ç›®ç»“æ„"
    
    # åˆ›å»ºç›®å½•ç»“æ„
    mkdir -p cmd/server
    mkdir -p internal/{auth,cache,config,database,handlers,logger,metrics,middleware,models,router,scheduler,services,utils,websocket}
    mkdir -p configs
    mkdir -p data
    mkdir -p deploy/{nginx}
    
    # åˆ›å»ºå®Œæ•´çš„main.goï¼ˆä¸å®é™…é¡¹ç›®ä¸€è‡´ï¼‰
    cat > cmd/server/main.go << 'EOF'
package main

import (
	"context"
	"fmt"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"

	"ai-monitor/internal/cache"
	"ai-monitor/internal/config"
	"ai-monitor/internal/database"
	"ai-monitor/internal/logger"
	"ai-monitor/internal/middleware"
	"ai-monitor/internal/router"
	"ai-monitor/internal/services"

	"github.com/gin-gonic/gin"
	"github.com/sirupsen/logrus"
)

// @title AIç›‘æ§ç³»ç»Ÿ API
// @version 1.0
// @description AIæ™ºèƒ½ç›‘æ§ç³»ç»Ÿçš„RESTful APIæ–‡æ¡£
// @termsOfService http://swagger.io/terms/

// @contact.name API Support
// @contact.url http://www.swagger.io/support
// @contact.email support@swagger.io

// @license.name MIT
// @license.url https://opensource.org/licenses/MIT

// @host localhost:8080
// @BasePath /api/v1

// @securityDefinitions.apikey BearerAuth
// @in header
// @name Authorization
// @description Type "Bearer" followed by a space and JWT token.

func main() {
	// åˆå§‹åŒ–é…ç½®
	// æ£€æŸ¥æ˜¯å¦æŒ‡å®šäº†é…ç½®æ–‡ä»¶
	configFile := "config"
	if len(os.Args) > 1 {
		configFile = os.Args[1]
	}
	
	cfg, err := config.LoadWithFile(configFile)
	if err != nil {
		logrus.Fatalf("Failed to load config: %v", err)
	}

	// åˆå§‹åŒ–æ—¥å¿—
	logger.Init(logger.Config{
		Level:      cfg.Logging.Level,
		Format:     cfg.Logging.Format,
		Output:     cfg.Logging.Output,
		FilePath:   cfg.Logging.FilePath,
		MaxSize:    cfg.Logging.MaxSize,
		MaxBackups: cfg.Logging.MaxBackups,
		MaxAge:     cfg.Logging.MaxAge,
		Compress:   cfg.Logging.Compress,
	})
	log := logrus.WithField("component", "main")

	log.Info("Starting AI Monitor System...")

	// è®¾ç½®Ginæ¨¡å¼
	gin.SetMode(cfg.Server.Mode)

	// åˆå§‹åŒ–æ•°æ®åº“
	if err := database.Initialize(&cfg.Database); err != nil {
		log.Fatal("Failed to initialize database:", err)
	}
	defer func() {
		if database.DB != nil {
			if sqlDB, err := database.DB.DB(); err == nil {
				sqlDB.Close()
			}
		}
	}()

	// åˆå§‹åŒ–Redisç¼“å­˜
	if err := cache.Initialize(&cfg.Redis); err != nil {
		log.Fatal("Failed to initialize Redis:", err)
	}
	defer cache.Close()

	// è¿è¡Œæ•°æ®åº“è¿ç§»
	if err := database.Migrate(); err != nil {
		log.Fatalf("Failed to run database migrations: %v", err)
	}

	// åˆå§‹åŒ–æœåŠ¡
	services, err := services.NewServices(cfg, database.DB)
	if err != nil {
		log.Fatalf("Failed to initialize services: %v", err)
	}

	// å¯åŠ¨åå°æœåŠ¡
	ctx, cancel := context.WithCancel(context.Background())
	defer cancel()

	if err := services.Start(ctx); err != nil {
		log.Fatalf("Failed to start services: %v", err)
	}

	// åˆå§‹åŒ–ä¸­é—´ä»¶ä¾èµ–
	middleware.InitializeMiddleware(services.GetJWTManager(), services.GetCacheManager(), cfg)

	// åˆå§‹åŒ–è·¯ç”±
	r := router.Setup(cfg, services)

	// åˆ›å»ºHTTPæœåŠ¡å™¨
	srv := &http.Server{
		Addr:           fmt.Sprintf("%s:%d", cfg.Server.Host, cfg.Server.Port),
		Handler:        r,
		ReadTimeout:    cfg.Server.ReadTimeout,
		WriteTimeout:   cfg.Server.WriteTimeout,
		IdleTimeout:    cfg.Server.IdleTimeout,
		MaxHeaderBytes: cfg.Server.MaxHeaderBytes,
	}

	// å¯åŠ¨æœåŠ¡å™¨
	go func() {
		log.Infof("Server starting on %s:%d", cfg.Server.Host, cfg.Server.Port)
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			log.Fatalf("Failed to start server: %v", err)
		}
	}()

	// ç­‰å¾…ä¸­æ–­ä¿¡å·
	quit := make(chan os.Signal, 1)
	signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
	<-quit

	log.Info("Shutting down server...")

	// ä¼˜é›…å…³é—­
	shutdownCtx, shutdownCancel := context.WithTimeout(context.Background(), 30*time.Second)
	defer shutdownCancel()

	// åœæ­¢åå°æœåŠ¡
	cancel()
	services.Stop()

	// å…³é—­HTTPæœåŠ¡å™¨
	if err := srv.Shutdown(shutdownCtx); err != nil {
		log.Errorf("Server forced to shutdown: %v", err)
	} else {
		log.Info("Server exited gracefully")
	}
}

// å¥åº·æ£€æŸ¥å¤„ç†å™¨
func healthCheck(c *gin.Context) {
	c.JSON(http.StatusOK, gin.H{
		"status":    "ok",
		"timestamp": time.Now().Unix(),
		"version":   "1.0.0",
		"service":   "ai-monitor",
	})
}

// ç‰ˆæœ¬ä¿¡æ¯å¤„ç†å™¨
func versionInfo(c *gin.Context) {
	c.JSON(http.StatusOK, gin.H{
		"version":     "1.0.0",
		"build_time":  "2024-01-01T00:00:00Z",
		"git_commit":  "unknown",
		"go_version":  "go1.21",
		"service":     "ai-monitor",
		"description": "AIæ™ºèƒ½ç›‘æ§ç³»ç»Ÿ",
	})
}
EOF

    # åˆ›å»ºå®Œæ•´çš„go.modï¼ˆä¸å®é™…é¡¹ç›®ä¸€è‡´ï¼‰
    cat > go.mod << 'EOF'
module ai-monitor

go 1.23.0

toolchain go1.24.4

require (
	github.com/gin-contrib/cors v1.7.6
	github.com/gin-contrib/pprof v1.5.3
	github.com/gin-gonic/gin v1.10.1
	github.com/glebarez/sqlite v1.11.0
	github.com/go-sql-driver/mysql v1.8.1
	github.com/golang-jwt/jwt/v5 v5.0.0
	github.com/google/uuid v1.6.0
	github.com/gorilla/websocket v1.5.0
	github.com/prometheus/client_golang v1.17.0
	github.com/prometheus/common v0.45.0
	github.com/redis/go-redis/v9 v9.11.0
	github.com/robfig/cron/v3 v3.0.1
	github.com/sashabaranov/go-openai v1.17.7
	github.com/sirupsen/logrus v1.9.3
	github.com/spf13/viper v1.17.0
	github.com/swaggo/files v1.0.1
	github.com/swaggo/gin-swagger v1.6.0
	golang.org/x/crypto v0.39.0
	gopkg.in/gomail.v2 v2.0.0-20160411212932-81ebce5c23df
	gorm.io/driver/mysql v1.6.0
	gorm.io/driver/postgres v1.5.4
	gorm.io/driver/sqlite v1.5.6
	gorm.io/gorm v1.30.0
)
EOF

    # åˆ›å»ºå†…éƒ¨åŒ…çš„åŸºç¡€æ–‡ä»¶
    create_internal_packages
    
    # åˆ›å»ºé…ç½®æ–‡ä»¶
    create_config_files
    
    # åˆ›å»ºæ•°æ®åº“åˆå§‹åŒ–æ–‡ä»¶
    create_database_files
    
    log_success "å®Œæ•´é¡¹ç›®ç»“æ„åˆ›å»ºå®Œæˆ"
}

# åˆ›å»ºå†…éƒ¨åŒ…
create_internal_packages() {
    log_info "åˆ›å»ºå†…éƒ¨åŒ…æ–‡ä»¶"
    
    # åˆ›å»ºé…ç½®åŒ…
    cat > internal/config/config.go << 'EOF'
package config

import (
	"time"
	"github.com/spf13/viper"
)

type Config struct {
	Server   ServerConfig   `mapstructure:"server"`
	Database DatabaseConfig `mapstructure:"database"`
	Redis    RedisConfig    `mapstructure:"redis"`
	Logging  LoggingConfig  `mapstructure:"logging"`
	JWT      JWTConfig      `mapstructure:"jwt"`
}

type ServerConfig struct {
	Host           string        `mapstructure:"host"`
	Port           int           `mapstructure:"port"`
	Mode           string        `mapstructure:"mode"`
	ReadTimeout    time.Duration `mapstructure:"read_timeout"`
	WriteTimeout   time.Duration `mapstructure:"write_timeout"`
	IdleTimeout    time.Duration `mapstructure:"idle_timeout"`
	MaxHeaderBytes int           `mapstructure:"max_header_bytes"`
}

type DatabaseConfig struct {
	Type     string `mapstructure:"type"`
	Host     string `mapstructure:"host"`
	Port     int    `mapstructure:"port"`
	User     string `mapstructure:"user"`
	Password string `mapstructure:"password"`
	Name     string `mapstructure:"name"`
	SSLMode  string `mapstructure:"ssl_mode"`
}

type RedisConfig struct {
	Host     string `mapstructure:"host"`
	Port     int    `mapstructure:"port"`
	Password string `mapstructure:"password"`
	DB       int    `mapstructure:"db"`
}

type LoggingConfig struct {
	Level      string `mapstructure:"level"`
	Format     string `mapstructure:"format"`
	Output     string `mapstructure:"output"`
	FilePath   string `mapstructure:"file_path"`
	MaxSize    int    `mapstructure:"max_size"`
	MaxBackups int    `mapstructure:"max_backups"`
	MaxAge     int    `mapstructure:"max_age"`
	Compress   bool   `mapstructure:"compress"`
}

type JWTConfig struct {
	Secret     string        `mapstructure:"secret"`
	Expiration time.Duration `mapstructure:"expiration"`
}

func LoadWithFile(configFile string) (*Config, error) {
	viper.SetConfigName(configFile)
	viper.SetConfigType("yaml")
	viper.AddConfigPath(".")
	viper.AddConfigPath("./configs")
	viper.AddConfigPath("/etc/ai-monitor/")

	// è®¾ç½®é»˜è®¤å€¼
	setDefaults()

	if err := viper.ReadInConfig(); err != nil {
		return nil, err
	}

	var config Config
	if err := viper.Unmarshal(&config); err != nil {
		return nil, err
	}

	return &config, nil
}

func setDefaults() {
	viper.SetDefault("server.host", "0.0.0.0")
	viper.SetDefault("server.port", 8080)
	viper.SetDefault("server.mode", "release")
	viper.SetDefault("server.read_timeout", "30s")
	viper.SetDefault("server.write_timeout", "30s")
	viper.SetDefault("server.idle_timeout", "60s")
	viper.SetDefault("server.max_header_bytes", 1048576)

	viper.SetDefault("database.type", "postgres")
	viper.SetDefault("database.host", "localhost")
	viper.SetDefault("database.port", 5432)
	viper.SetDefault("database.user", "aimonitor")
	viper.SetDefault("database.password", "aimonitor123")
	viper.SetDefault("database.name", "ai_monitor")
	viper.SetDefault("database.ssl_mode", "disable")

	viper.SetDefault("redis.host", "localhost")
	viper.SetDefault("redis.port", 6379)
	viper.SetDefault("redis.password", "")
	viper.SetDefault("redis.db", 0)

	viper.SetDefault("logging.level", "info")
	viper.SetDefault("logging.format", "json")
	viper.SetDefault("logging.output", "stdout")
	viper.SetDefault("logging.file_path", "logs/app.log")
	viper.SetDefault("logging.max_size", 100)
	viper.SetDefault("logging.max_backups", 3)
	viper.SetDefault("logging.max_age", 28)
	viper.SetDefault("logging.compress", true)

	viper.SetDefault("jwt.secret", "your-secret-key")
	viper.SetDefault("jwt.expiration", "24h")
}
EOF

    # åˆ›å»ºæ•°æ®åº“åŒ…
    cat > internal/database/database.go << 'EOF'
package database

import (
	"fmt"
	"ai-monitor/internal/models"
	"gorm.io/driver/postgres"
	"gorm.io/driver/mysql"
	"gorm.io/driver/sqlite"
	"gorm.io/gorm"
	"gorm.io/gorm/logger"
)

var DB *gorm.DB

type DatabaseConfig struct {
	Type     string `mapstructure:"type"`
	Host     string `mapstructure:"host"`
	Port     int    `mapstructure:"port"`
	User     string `mapstructure:"user"`
	Password string `mapstructure:"password"`
	Name     string `mapstructure:"name"`
	SSLMode  string `mapstructure:"ssl_mode"`
}

func Initialize(config *DatabaseConfig) error {
	var dialector gorm.Dialector

	switch config.Type {
	case "postgres":
		dsn := fmt.Sprintf("host=%s user=%s password=%s dbname=%s port=%d sslmode=%s",
			config.Host, config.User, config.Password, config.Name, config.Port, config.SSLMode)
		dialector = postgres.Open(dsn)
	case "mysql":
		dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&parseTime=True&loc=Local",
			config.User, config.Password, config.Host, config.Port, config.Name)
		dialector = mysql.Open(dsn)
	case "sqlite":
		dialector = sqlite.Open(config.Name)
	default:
		return fmt.Errorf("unsupported database type: %s", config.Type)
	}

	db, err := gorm.Open(dialector, &gorm.Config{
		Logger: logger.Default.LogMode(logger.Info),
	})
	if err != nil {
		return err
	}

	DB = db
	return nil
}

func Migrate() error {
	return DB.AutoMigrate(
		&models.User{},
		&models.Agent{},
		&models.Alert{},
		&models.Metric{},
	)
}
EOF

    # åˆ›å»ºæ¨¡å‹åŒ…
    cat > internal/models/models.go << 'EOF'
package models

import (
	"time"
	"gorm.io/gorm"
)

type User struct {
	ID        uint           `json:"id" gorm:"primarykey"`
	CreatedAt time.Time      `json:"created_at"`
	UpdatedAt time.Time      `json:"updated_at"`
	DeletedAt gorm.DeletedAt `json:"-" gorm:"index"`
	Username  string         `json:"username" gorm:"uniqueIndex;not null"`
	Email     string         `json:"email" gorm:"uniqueIndex"`
	Password  string         `json:"-" gorm:"not null"`
	Role      string         `json:"role" gorm:"default:user"`
	IsActive  bool           `json:"is_active" gorm:"default:true"`
}

type Agent struct {
	ID            uint           `json:"id" gorm:"primarykey"`
	CreatedAt     time.Time      `json:"created_at"`
	UpdatedAt     time.Time      `json:"updated_at"`
	DeletedAt     gorm.DeletedAt `json:"-" gorm:"index"`
	Name          string         `json:"name" gorm:"not null"`
	Type          string         `json:"type" gorm:"not null"`
	Host          string         `json:"host" gorm:"not null"`
	Port          int            `json:"port"`
	Status        string         `json:"status" gorm:"default:offline"`
	LastHeartbeat *time.Time     `json:"last_heartbeat"`
	Config        string         `json:"config" gorm:"type:text"`
}

type Alert struct {
	ID          uint           `json:"id" gorm:"primarykey"`
	CreatedAt   time.Time      `json:"created_at"`
	UpdatedAt   time.Time      `json:"updated_at"`
	DeletedAt   gorm.DeletedAt `json:"-" gorm:"index"`
	Title       string         `json:"title" gorm:"not null"`
	Description string         `json:"description" gorm:"type:text"`
	Severity    string         `json:"severity" gorm:"not null"`
	Status      string         `json:"status" gorm:"default:open"`
	AgentID     uint           `json:"agent_id"`
	Agent       Agent          `json:"agent" gorm:"foreignKey:AgentID"`
}

type Metric struct {
	ID        uint           `json:"id" gorm:"primarykey"`
	CreatedAt time.Time      `json:"created_at"`
	UpdatedAt time.Time      `json:"updated_at"`
	DeletedAt gorm.DeletedAt `json:"-" gorm:"index"`
	Name      string         `json:"name" gorm:"not null"`
	Value     float64        `json:"value"`
	Unit      string         `json:"unit"`
	AgentID   uint           `json:"agent_id"`
	Agent     Agent          `json:"agent" gorm:"foreignKey:AgentID"`
	Timestamp time.Time      `json:"timestamp"`
}
EOF

    # åˆ›å»ºå…¶ä»–å¿…è¦çš„åŒ…æ–‡ä»¶ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
    echo 'package cache' > internal/cache/redis.go
    echo 'package logger' > internal/logger/logger.go
    echo 'package services' > internal/services/services.go
    echo 'package router' > internal/router/router.go
    echo 'package middleware' > internal/middleware/simple.go
    echo 'package handlers' > internal/handlers/handlers.go
    echo 'package auth' > internal/auth/jwt.go
    echo 'package utils' > internal/utils/utils.go
    echo 'package websocket' > internal/websocket/websocket.go
    echo 'package metrics' > internal/metrics/metrics.go
    echo 'package scheduler' > internal/scheduler/scheduler.go
}

# åˆ›å»ºé…ç½®æ–‡ä»¶
create_config_files() {
    log_info "åˆ›å»ºé…ç½®æ–‡ä»¶"
    
    cat > configs/config.yaml << 'EOF'
server:
  host: "0.0.0.0"
  port: 8080
  mode: "release"
  read_timeout: "30s"
  write_timeout: "30s"
  idle_timeout: "60s"
  max_header_bytes: 1048576

database:
  type: "postgres"
  host: "postgres"
  port: 5432
  user: "aimonitor"
  password: "aimonitor123"
  name: "ai_monitor"
  ssl_mode: "disable"

redis:
  host: "redis"
  port: 6379
  password: ""
  db: 0

logging:
  level: "info"
  format: "json"
  output: "stdout"
  file_path: "logs/app.log"
  max_size: 100
  max_backups: 3
  max_age: 28
  compress: true

jwt:
  secret: "your-secret-key-change-in-production"
  expiration: "24h"
EOF

    cat > configs/config.dev.yaml << 'EOF'
server:
  host: "localhost"
  port: 8080
  mode: "debug"

database:
  type: "sqlite"
  name: "data/aimonitor.db"

redis:
  host: "localhost"
  port: 6379

logging:
  level: "debug"
  format: "text"
  output: "stdout"
EOF
}

# åˆ›å»ºæ•°æ®åº“æ–‡ä»¶
create_database_files() {
    log_info "åˆ›å»ºæ•°æ®åº“åˆå§‹åŒ–æ–‡ä»¶"
    
    cat > init.sql << 'EOF'
CREATE DATABASE IF NOT EXISTS ai_monitor;
\c ai_monitor;

CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    role VARCHAR(20) DEFAULT 'user',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS agents (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL,
    host VARCHAR(255) NOT NULL,
    port INTEGER,
    status VARCHAR(20) DEFAULT 'offline',
    last_heartbeat TIMESTAMP,
    config TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS alerts (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    severity VARCHAR(20) NOT NULL,
    status VARCHAR(20) DEFAULT 'open',
    agent_id INTEGER REFERENCES agents(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS metrics (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    value DECIMAL(10,2),
    unit VARCHAR(20),
    agent_id INTEGER REFERENCES agents(id),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO users (username, password, email, role) VALUES 
('admin', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'admin@aimonitor.com', 'admin')
ON CONFLICT (username) DO NOTHING;

INSERT INTO agents (name, type, host, status) VALUES 
('ç³»ç»Ÿç›‘æ§ä»£ç†', 'system', 'localhost', 'online'),
('ç½‘ç»œç›‘æ§ä»£ç†', 'network', 'localhost', 'online'),
('åº”ç”¨ç›‘æ§ä»£ç†', 'application', 'localhost', 'online');
EOF
}

# åˆ›å»ºDockerå’Œé…ç½®æ–‡ä»¶
create_docker_configs() {
    log_info "åˆ›å»ºDockeré…ç½®æ–‡ä»¶"
    
    # åˆ›å»ºdocker-compose.ymlï¼ˆé€‚é…ç°æœ‰é¡¹ç›®ï¼‰
    cat > docker-compose.yml << 'EOF'
version: '3.8'

services:
  # AI Monitor åç«¯æœåŠ¡
  aimonitor:
    build: .
    container_name: aimonitor-backend
    ports:
      - "8080:8080"
    environment:
      - GIN_MODE=release
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=aimonitor
      - DB_PASSWORD=aimonitor123
      - DB_NAME=ai_monitor
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - postgres
      - redis
    volumes:
      - ./configs:/app/configs
      - ./data:/app/data
    networks:
      - aimonitor-network
    restart: unless-stopped

  # å‰ç«¯æœåŠ¡
  frontend:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: aimonitor-frontend
    ports:
      - "3000:3000"
    environment:
      - VITE_API_BASE_URL=http://localhost:8080
    depends_on:
      - aimonitor
    networks:
      - aimonitor-network
    restart: unless-stopped

  # PostgreSQL æ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    container_name: aimonitor-postgres
    environment:
      POSTGRES_DB: ai_monitor
      POSTGRES_USER: aimonitor
      POSTGRES_PASSWORD: aimonitor123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - aimonitor-network
    restart: unless-stopped

  # Redis ç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: aimonitor-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - aimonitor-network
    restart: unless-stopped

  # Prometheus ç›‘æ§
  prometheus:
    image: prom/prometheus:latest
    container_name: aimonitor-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./configs/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
    networks:
      - aimonitor-network
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  prometheus_data:

networks:
  aimonitor-network:
    driver: bridge
EOF

    # åˆ›å»ºDockerfileï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if [ ! -f "Dockerfile" ]; then
        cat > Dockerfile << 'EOF'
FROM golang:1.21-alpine AS builder

WORKDIR /app
COPY go.mod go.sum ./
RUN apk add --no-cache git ca-certificates curl && \
    go env -w GOPROXY=https://goproxy.cn,direct && \
    go env -w GOSUMDB=sum.golang.org && \
    go env -w GO111MODULE=on && \
    ([ ! -f go.sum ] && touch go.sum || true) && \
    for i in 1 2 3; do echo "Go mod download attempt $i/3" && go mod download -x && break || (echo "Download failed, retrying in 5s..." && sleep 5); done

COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main cmd/server/main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates tzdata
WORKDIR /root/

COPY --from=builder /app/main .
COPY --from=builder /app/configs ./configs

EXPOSE 8080
CMD ["./main"]
EOF
    fi

    # åˆ›å»ºå‰ç«¯Dockerfileï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if [ ! -f "web/Dockerfile" ]; then
        mkdir -p web
        cat > web/Dockerfile << 'EOF'
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm config set registry https://registry.npmmirror.com && npm install

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 3000
CMD ["nginx", "-g", "daemon off;"]
EOF

        # åˆ›å»ºnginxé…ç½®
        cat > web/nginx.conf << 'EOF'
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    server {
        listen 3000;
        server_name localhost;
        
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ /index.html;
        }
        
        location /api {
            proxy_pass http://aimonitor:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
EOF
    fi

    log_success "Dockerå’Œé…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
}

# åˆ›å»ºç°ä»£åŒ–å‰ç«¯
create_frontend() {
    # æ£€æŸ¥æ˜¯å¦å­˜åœ¨å‰ç«¯é¡¹ç›®
    if [ -f "web/package.json" ] && [ -d "web/src" ]; then
        log_success "æ£€æµ‹åˆ°ç°æœ‰å‰ç«¯é¡¹ç›®ï¼Œè·³è¿‡åˆ›å»º"
        return 0
    fi
    
    log_info "åˆ›å»ºç°ä»£åŒ–å‰ç«¯ç•Œé¢"
    
    # åˆ›å»ºpackage.json
    cat > web/package.json << 'EOF'
{
  "name": "ai-monitor-web",
  "version": "1.0.0",
  "description": "AI Monitor System Web Frontend",
  "private": true,
  "scripts": {
    "dev": "vite --host 0.0.0.0",
    "build": "vite build --mode production",
    "preview": "vite preview"
  },
  "dependencies": {
    "@ant-design/icons": "^5.2.6",
    "antd": "^5.12.8",
    "axios": "^1.6.2",
    "dayjs": "^1.11.10",
    "echarts": "^5.4.3",
    "echarts-for-react": "^3.0.2",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.8.1"
  },
  "devDependencies": {
    "@types/node": "^20.3.0",
    "@types/react": "^18.2.43",
    "@types/react-dom": "^18.2.17",
    "@typescript-eslint/eslint-plugin": "^5.59.0",
    "@typescript-eslint/parser": "^5.59.0",
    "@vitejs/plugin-react": "^4.2.1",
    "eslint": "^8.42.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.0",
    "typescript": "^5.2.2",
    "vite": "^5.0.8"
  },
  "engines": {
    "node": ">=16.0.0",
    "npm": ">=8.0.0"
  }
}
EOF

    # åˆ›å»ºvite.config.ts
    cat > web/vite.config.ts << 'EOF'
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    host: '0.0.0.0',
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://aimonitor:8080',
        changeOrigin: true
      }
    }
  }
})
EOF

    # åˆ›å»ºindex.html
    cat > web/index.html << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Monitor æ™ºèƒ½ç›‘æ§ç³»ç»Ÿ</title>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>
EOF

    # åˆ›å»ºTypeScripté…ç½®
    cat > web/tsconfig.json << 'EOF'
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
EOF

    # åˆ›å»ºNode.js TypeScripté…ç½®
    cat > web/tsconfig.node.json << 'EOF'
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}
EOF

    # åˆ›å»ºReactä¸»æ–‡ä»¶
    mkdir -p web/src
    cat > web/src/main.tsx << 'EOF'
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.tsx'
import 'antd/dist/reset.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)
EOF

    # åˆ›å»ºç®€åŒ–çš„Appç»„ä»¶
    cat > web/src/App.tsx << 'EOF'
import React, { useState, useEffect } from 'react';
import { Layout, Menu, Card, Row, Col, Statistic, Table, Tag, Button, Space } from 'antd';
import {
  DashboardOutlined,
  MonitorOutlined,
  SettingOutlined,
  AlertOutlined,
  DatabaseOutlined
} from '@ant-design/icons';
import axios from 'axios';

const { Header, Sider, Content } = Layout;

interface SystemStatus {
  message: string;
  version: string;
  uptime: string;
  services: {
    database: string;
    redis: string;
    prometheus: string;
    elasticsearch: string;
  };
}

interface Agent {
  id: number;
  name: string;
  status: string;
  type: string;
}

const App: React.FC = () => {
  const [collapsed, setCollapsed] = useState(false);
  const [selectedKey, setSelectedKey] = useState('1');
  const [systemStatus, setSystemStatus] = useState<SystemStatus | null>(null);
  const [agents, setAgents] = useState<Agent[]>([]);

  useEffect(() => {
    fetchSystemStatus();
    fetchAgents();
    
    const interval = setInterval(() => {
      fetchSystemStatus();
      fetchAgents();
    }, 30000);

    return () => clearInterval(interval);
  }, []);

  const fetchSystemStatus = async () => {
    try {
      const response = await axios.get('/api/v1/status');
      setSystemStatus(response.data);
    } catch (error) {
      console.error('Failed to fetch system status:', error);
    }
  };

  const fetchAgents = async () => {
    try {
      const response = await axios.get('/api/v1/agents');
      setAgents(response.data.agents);
    } catch (error) {
      console.error('Failed to fetch agents:', error);
    }
  };

  const menuItems = [
    {
      key: '1',
      icon: <DashboardOutlined />,
      label: 'ä»ªè¡¨æ¿',
    },
    {
      key: '2',
      icon: <MonitorOutlined />,
      label: 'ç›‘æ§ä»£ç†',
    },
    {
      key: '3',
      icon: <AlertOutlined />,
      label: 'å‘Šè­¦ç®¡ç†',
    },
    {
      key: '4',
      icon: <DatabaseOutlined />,
      label: 'æ•°æ®ç®¡ç†',
    },
    {
      key: '5',
      icon: <SettingOutlined />,
      label: 'ç³»ç»Ÿè®¾ç½®',
    },
  ];

  const agentColumns = [
    {
      title: 'ID',
      dataIndex: 'id',
      key: 'id',
    },
    {
      title: 'ä»£ç†åç§°',
      dataIndex: 'name',
      key: 'name',
    },
    {
      title: 'ç±»å‹',
      dataIndex: 'type',
      key: 'type',
      render: (type: string) => {
        const color = type === 'system' ? 'blue' : type === 'network' ? 'green' : 'orange';
        return <Tag color={color}>{type}</Tag>;
      },
    },
    {
      title: 'çŠ¶æ€',
      dataIndex: 'status',
      key: 'status',
      render: (status: string) => {
        const color = status === 'online' ? 'green' : 'red';
        return <Tag color={color}>{status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}</Tag>;
      },
    },
    {
      title: 'æ“ä½œ',
      key: 'action',
      render: () => (
        <Space size="middle">
          <Button type="link" size="small">æŸ¥çœ‹è¯¦æƒ…</Button>
          <Button type="link" size="small">é‡å¯</Button>
        </Space>
      ),
    },
  ];

  const renderDashboard = () => (
    <div>
      <Row gutter={16}>
        <Col span={6}>
          <Card>
            <Statistic
              title="CPUä½¿ç”¨ç‡"
              value={45.2}
              precision={1}
              valueStyle={{ color: '#3f8600' }}
              suffix="%"
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="å†…å­˜ä½¿ç”¨ç‡"
              value={67.8}
              precision={1}
              valueStyle={{ color: '#cf1322' }}
              suffix="%"
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="ç£ç›˜ä½¿ç”¨ç‡"
              value={23.1}
              precision={1}
              valueStyle={{ color: '#1890ff' }}
              suffix="%"
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="æ´»è·ƒå‘Šè­¦"
              value={2}
              valueStyle={{ color: '#faad14' }}
              prefix={<AlertOutlined />}
            />
          </Card>
        </Col>
      </Row>
      
      <Row gutter={16} style={{ marginTop: 16 }}>
        <Col span={12}>
          <Card title="ç³»ç»ŸçŠ¶æ€">
            {systemStatus && (
              <div>
                <p><strong>ç‰ˆæœ¬:</strong> {systemStatus.version}</p>
                <p><strong>è¿è¡Œæ—¶é—´:</strong> {systemStatus.uptime}</p>
                <p><strong>æ•°æ®åº“:</strong> <Tag color="green">{systemStatus.services.database}</Tag></p>
                <p><strong>Redis:</strong> <Tag color="green">{systemStatus.services.redis}</Tag></p>
                <p><strong>Prometheus:</strong> <Tag color="green">{systemStatus.services.prometheus}</Tag></p>
                <p><strong>Elasticsearch:</strong> <Tag color="green">{systemStatus.services.elasticsearch}</Tag></p>
              </div>
            )}
          </Card>
        </Col>
        <Col span={12}>
          <Card title="å¿«é€Ÿæ“ä½œ">
            <Space direction="vertical" style={{ width: '100%' }}>
              <Button type="primary" block>æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—</Button>
              <Button block>é‡å¯æ‰€æœ‰æœåŠ¡</Button>
              <Button block>å¯¼å‡ºç›‘æ§æ•°æ®</Button>
              <Button block>ç³»ç»Ÿå¥åº·æ£€æŸ¥</Button>
            </Space>
          </Card>
        </Col>
      </Row>
    </div>
  );

  const renderAgents = () => (
    <Card title="ç›‘æ§ä»£ç†åˆ—è¡¨">
      <Table
        columns={agentColumns}
        dataSource={agents}
        rowKey="id"
        pagination={{ pageSize: 10 }}
      />
    </Card>
  );

  const renderContent = () => {
    switch (selectedKey) {
      case '1':
        return renderDashboard();
      case '2':
        return renderAgents();
      case '3':
        return <Card title="å‘Šè­¦ç®¡ç†"><p>å‘Šè­¦ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...</p></Card>;
      case '4':
        return <Card title="æ•°æ®ç®¡ç†"><p>æ•°æ®ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...</p></Card>;
      case '5':
        return <Card title="ç³»ç»Ÿè®¾ç½®"><p>ç³»ç»Ÿè®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...</p></Card>;
      default:
        return renderDashboard();
    }
  };

  return (
    <Layout style={{ minHeight: '100vh' }}>
      <Sider collapsible collapsed={collapsed} onCollapse={setCollapsed}>
        <div style={{ height: 32, margin: 16, background: 'rgba(255, 255, 255, 0.3)' }} />
        <Menu
          theme="dark"
          defaultSelectedKeys={['1']}
          mode="inline"
          items={menuItems}
          onClick={({ key }) => setSelectedKey(key)}
        />
      </Sider>
      <Layout>
        <Header style={{ padding: 0, background: '#fff' }}>
          <div style={{ padding: '0 24px', fontSize: '18px', fontWeight: 'bold' }}>
            ğŸš€ AI Monitor æ™ºèƒ½ç›‘æ§ç³»ç»Ÿ
          </div>
        </Header>
        <Content style={{ margin: '24px 16px', padding: 24, background: '#fff' }}>
          {renderContent()}
        </Content>
      </Layout>
    </Layout>
  );
};

export default App;
EOF

    log_success "ç°ä»£åŒ–å‰ç«¯ç•Œé¢åˆ›å»ºå®Œæˆ"
}

# å¯åŠ¨æœåŠ¡
start_services() {
    log_info "å¯åŠ¨AI Monitorå®Œæ•´æœåŠ¡..."
    
    # åœæ­¢å¯èƒ½å­˜åœ¨çš„æ—§æœåŠ¡
    docker-compose down 2>/dev/null || true
    
    # å¯åŠ¨æœåŠ¡
    if docker-compose up -d; then
        log_success "æœåŠ¡å¯åŠ¨æˆåŠŸ"
    else
        log_error "æœåŠ¡å¯åŠ¨å¤±è´¥"
        exit 1
    fi
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    log_info "ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨..."
    log_info "æ­£åœ¨æ‹‰å–Dockeré•œåƒå¹¶å¯åŠ¨å®¹å™¨ï¼Œé¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´..."
    sleep 30
    
    # å¥åº·æ£€æŸ¥
    log_info "è¿›è¡ŒæœåŠ¡å¥åº·æ£€æŸ¥..."
    
    local max_attempts=15
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if curl -s http://localhost:8080/health > /dev/null 2>&1; then
            log_success "åç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
            break
        else
            log_warning "åç«¯æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯•ä¸­... ($attempt/$max_attempts)"
            sleep 10
            ((attempt++))
        fi
    done
    
    if [ $attempt -gt $max_attempts ]; then
        log_error "åç«¯æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€"
        docker-compose logs aimonitor
        exit 1
    fi
    
    # æ£€æŸ¥å‰ç«¯æœåŠ¡
    attempt=1
    while [ $attempt -le $max_attempts ]; do
        if curl -s http://localhost:3000 > /dev/null 2>&1; then
            log_success "å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
            break
        else
            log_warning "å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯•ä¸­... ($attempt/$max_attempts)"
            sleep 10
            ((attempt++))
        fi
    done
    
    if [ $attempt -gt $max_attempts ]; then
        log_warning "å‰ç«¯æœåŠ¡å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´å¯åŠ¨ï¼Œè¯·ç¨åè®¿é—®"
    fi
}

# æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
show_result() {
    clear
    echo -e "${GREEN}"
    echo "ğŸ‰ğŸ‰ğŸ‰ AI Monitor å®Œæ•´ç‰ˆéƒ¨ç½²æˆåŠŸï¼ğŸ‰ğŸ‰ğŸ‰"
    echo -e "${NC}"
    echo -e "${BLUE}ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:${NC}"
    echo "   é¡¹ç›®ç›®å½•: $PROJECT_DIR"
    echo "   æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    echo ""
    echo -e "${GREEN}ğŸŒ è®¿é—®åœ°å€:${NC}"
    echo "   å‰ç«¯ç•Œé¢: http://localhost:3000"
    echo "   åç«¯API: http://localhost:8080/api/v1/status"
    echo "   å¥åº·æ£€æŸ¥: http://localhost:8080/health"
    echo "   Prometheus: http://localhost:9090"
    echo "   Elasticsearch: http://localhost:9200"
    echo ""
    echo -e "${YELLOW}ğŸ‘¤ é»˜è®¤è´¦å·:${NC}"
    echo "   ç”¨æˆ·å: admin"
    echo "   å¯†ç : admin123"
    echo ""
    echo -e "${BLUE}ğŸ”§ å¸¸ç”¨å‘½ä»¤:${NC}"
    echo "   æŸ¥çœ‹æœåŠ¡çŠ¶æ€: cd $PROJECT_DIR && docker-compose ps"
    echo "   æŸ¥çœ‹æ—¥å¿—: cd $PROJECT_DIR && docker-compose logs"
    echo "   é‡å¯æœåŠ¡: cd $PROJECT_DIR && docker-compose restart"
    echo "   åœæ­¢æœåŠ¡: cd $PROJECT_DIR && docker-compose down"
    echo ""
    echo -e "${GREEN}âœ… éƒ¨ç½²å®Œæˆï¼Œæ‰€æœ‰æœåŠ¡å·²è‡ªåŠ¨å¯åŠ¨ï¼${NC}"
    echo -e "${BLUE}ğŸ“Š åŒ…å«å®Œæ•´çš„å‰ç«¯ç•Œé¢ã€Prometheusç›‘æ§å’ŒElasticsearchæœç´¢åŠŸèƒ½${NC}"
    echo -e "${YELLOW}ğŸ’¡ æç¤º: å¦‚æœå‰ç«¯é¡µé¢æš‚æ—¶æ— æ³•è®¿é—®ï¼Œè¯·ç­‰å¾…1-2åˆ†é’Ÿè®©æœåŠ¡å®Œå…¨å¯åŠ¨${NC}"
}

# åˆå§‹åŒ–Goæ¨¡å—
init_go_modules() {
    log_info "åˆå§‹åŒ–Goæ¨¡å—"
    
    # å¦‚æœå­˜åœ¨go.modä½†æ²¡æœ‰go.sumï¼Œæˆ–è€…go.sumä¸ºç©º
    if [ -f "go.mod" ]; then
        if [ ! -f "go.sum" ] || [ ! -s "go.sum" ]; then
            log_info "æ£€æµ‹åˆ°go.modæ–‡ä»¶ï¼Œä½†go.sumæ–‡ä»¶ç¼ºå¤±æˆ–ä¸ºç©º"
            log_info "æ­£åœ¨åˆå§‹åŒ–Goæ¨¡å—..."
            
            # è®¾ç½®Goç¯å¢ƒå˜é‡
            export GOPROXY="https://goproxy.cn,direct"
            export GOSUMDB="sum.golang.org"
            export GO111MODULE="on"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰Goå‘½ä»¤
            if command -v go &> /dev/null; then
                log_info "ä½¿ç”¨æœ¬åœ°Goç¯å¢ƒåˆå§‹åŒ–æ¨¡å—"
                go mod download 2>/dev/null || log_warning "æœ¬åœ°Goæ¨¡å—ä¸‹è½½å¤±è´¥ï¼Œå°†åœ¨Dockerä¸­å¤„ç†"
                go mod tidy 2>/dev/null || log_warning "æœ¬åœ°Goæ¨¡å—æ•´ç†å¤±è´¥ï¼Œå°†åœ¨Dockerä¸­å¤„ç†"
            else
                log_info "æœ¬åœ°æœªå®‰è£…Goï¼Œå°†åœ¨Dockerå®¹å™¨ä¸­å¤„ç†æ¨¡å—åˆå§‹åŒ–"
                # åˆ›å»ºç©ºçš„go.sumæ–‡ä»¶ï¼Œé¿å…Dockeræ„å»ºæ—¶æŠ¥é”™
                touch go.sum
            fi
            
            log_success "Goæ¨¡å—åˆå§‹åŒ–å®Œæˆ"
        else
            log_success "go.sumæ–‡ä»¶å·²å­˜åœ¨ä¸”ä¸ä¸ºç©º"
        fi
    else
        log_info "æœªæ£€æµ‹åˆ°go.modæ–‡ä»¶ï¼Œè·³è¿‡Goæ¨¡å—åˆå§‹åŒ–"
    fi
}

# ä¸»å‡½æ•°
main() {
    show_welcome
    setup_project_dir
    detect_os
    install_docker
    install_docker_compose
    create_project_files
    init_go_modules
    create_frontend
    start_services
    show_result
}

# é”™è¯¯å¤„ç†
trap 'log_error "éƒ¨ç½²è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—: $LOG_FILE"' ERR

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"