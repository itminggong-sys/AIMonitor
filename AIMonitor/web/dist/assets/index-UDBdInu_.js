import{u as e,j as t}from"./index-BC7s2n7i.js";import{r as s}from"./vendor-D6r2_tUy.js";import{J as a,d as i,T as r,$ as n,a0 as l,N as o,a1 as d,S as c,B as x,aa as h,_ as p,a5 as y,a6 as j,O as u,a9 as m,a8 as f,Q as g,aj as k,aG as I,ae as w,b as v,al as A,ab as _,am as S,c as C}from"./antd-CJ5_bEWz.js";const{Title:P,Text:T}=r,{TextArea:K}=u,b=()=>{const[r,b]=s.useState([]),[Y,z]=s.useState(!1),[B,D]=s.useState(!1),[F,M]=s.useState(null),[$]=a.useForm(),[O,E]=s.useState(new Set),{token:H}=e(),J=async()=>{z(!0);try{const e=await fetch("/api/v1/api-keys",{headers:{Authorization:`Bearer ${H}`,"Content-Type":"application/json"}});if(e.ok){const t=await e.json();b(t.data||[])}else f.error("获取API Key列表失败")}catch(e){f.error("网络错误，请稍后重试")}finally{z(!1)}},U=(e,t)=>O.has(t)?e:e.substring(0,8)+"****"+e.substring(e.length-4),N=[{title:"名称",dataIndex:"name",key:"name",width:150},{title:"API Key",dataIndex:"key",key:"key",width:300,render:(e,s)=>t.jsxs(c,{children:[t.jsx(T,{code:!0,style:{fontFamily:"monospace"},children:U(e,s.id)}),t.jsx(x,{type:"text",size:"small",icon:O.has(s.id)?t.jsx(g,{}):t.jsx(k,{}),onClick:()=>(e=>{const t=new Set(O);t.has(e)?t.delete(e):t.add(e),E(t)})(s.id)}),t.jsx(x,{type:"text",size:"small",icon:t.jsx(I,{}),onClick:()=>(e=>{navigator.clipboard.writeText(e).then(()=>{f.success("API Key已复制到剪贴板")})})(e)})]})},{title:"描述",dataIndex:"description",key:"description",ellipsis:!0},{title:"状态",dataIndex:"status",key:"status",width:100,render:(e,s)=>t.jsx(w,{checked:"active"===e,onChange:()=>(async(e,t)=>{try{const s="active"===t?"inactive":"active";(await fetch(`/api/v1/api-keys/${e}`,{method:"PUT",headers:{Authorization:`Bearer ${H}`,"Content-Type":"application/json"},body:JSON.stringify({status:s})})).ok?(f.success("状态更新成功"),J()):f.error("状态更新失败")}catch(s){f.error("网络错误，请稍后重试")}})(s.id,e),checkedChildren:"启用",unCheckedChildren:"禁用"})},{title:"使用次数",dataIndex:"usage_count",key:"usage_count",width:100,render:e=>t.jsx(v,{color:e>0?"green":"default",children:e})},{title:"最后使用",dataIndex:"last_used_at",key:"last_used_at",width:150,render:e=>e?i(e).format("YYYY-MM-DD HH:mm"):"从未使用"},{title:"过期时间",dataIndex:"expires_at",key:"expires_at",width:150,render:e=>{if(!e)return"永不过期";const s=i(e),a=s.isBefore(i());return t.jsx(v,{color:a?"red":"green",children:s.format("YYYY-MM-DD")})}},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:150,render:e=>i(e).format("YYYY-MM-DD HH:mm")},{title:"操作",key:"action",width:120,render:(e,s)=>t.jsxs(c,{children:[t.jsx(A,{title:"编辑",children:t.jsx(x,{type:"text",size:"small",icon:t.jsx(_,{}),onClick:()=>(e=>{M(e),$.setFieldsValue({name:e.name,description:e.description,expires_at:e.expires_at?i(e.expires_at):null}),D(!0)})(s)})}),t.jsx(S,{title:"确定要删除这个API Key吗？",description:"删除后将无法恢复，请谨慎操作。",onConfirm:()=>(async e=>{try{(await fetch(`/api/v1/api-keys/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${H}`}})).ok?(f.success("API Key删除成功"),J()):f.error("删除失败")}catch(t){f.error("网络错误，请稍后重试")}})(s.id),okText:"确定",cancelText:"取消",children:t.jsx(A,{title:"删除",children:t.jsx(x,{type:"text",size:"small",danger:!0,icon:t.jsx(C,{})})})})]})}];s.useEffect(()=>{J()},[]);const Q={total:r.length,active:r.filter(e=>"active"===e.status).length,expired:r.filter(e=>e.expires_at&&i(e.expires_at).isBefore(i())).length,totalUsage:r.reduce((e,t)=>e+t.usage_count,0)};return t.jsxs("div",{style:{padding:"24px"},children:[t.jsx(P,{level:2,children:"API Key 管理"}),t.jsxs(n,{gutter:16,style:{marginBottom:"24px"},children:[t.jsx(l,{span:6,children:t.jsx(o,{children:t.jsx(d,{title:"总数量",value:Q.total})})}),t.jsx(l,{span:6,children:t.jsx(o,{children:t.jsx(d,{title:"启用中",value:Q.active,valueStyle:{color:"#3f8600"}})})}),t.jsx(l,{span:6,children:t.jsx(o,{children:t.jsx(d,{title:"已过期",value:Q.expired,valueStyle:{color:"#cf1322"}})})}),t.jsx(l,{span:6,children:t.jsx(o,{children:t.jsx(d,{title:"总使用次数",value:Q.totalUsage})})})]}),t.jsxs(o,{children:[t.jsxs("div",{style:{marginBottom:"16px",display:"flex",justifyContent:"space-between"},children:[t.jsx(c,{children:t.jsx(x,{type:"primary",icon:t.jsx(h,{}),onClick:()=>{M(null),$.resetFields(),D(!0)},children:"创建 API Key"})}),t.jsx(x,{icon:t.jsx(p,{}),onClick:J,loading:Y,children:"刷新"})]}),t.jsx(y,{columns:N,dataSource:r,rowKey:"id",loading:Y,pagination:{pageSize:10,showSizeChanger:!0,showQuickJumper:!0,showTotal:e=>`共 ${e} 条记录`},scroll:{x:1200}})]}),t.jsx(j,{title:F?"编辑 API Key":"创建 API Key",open:B,onCancel:()=>{D(!1),M(null),$.resetFields()},footer:null,width:600,children:t.jsxs(a,{form:$,layout:"vertical",onFinish:async e=>{try{const t=(()=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="ak_";for(let s=0;s<32;s++)t+=e.charAt(Math.floor(62*Math.random()));return t})(),s={name:e.name,key:t,description:e.description||"",expires_at:e.expires_at?e.expires_at.toISOString():null},a=F?`/api/v1/api-keys/${F.id}`:"/api/v1/api-keys",i=F?"PUT":"POST",r=await fetch(a,{method:i,headers:{Authorization:`Bearer ${H}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(r.ok)f.success(F?"API Key更新成功":"API Key创建成功"),D(!1),M(null),$.resetFields(),J();else{const e=await r.json();f.error(e.message||"操作失败")}}catch(t){f.error("网络错误，请稍后重试")}},children:[t.jsx(a.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入API Key名称"},{max:50,message:"名称不能超过50个字符"}],children:t.jsx(u,{placeholder:"请输入API Key名称"})}),t.jsx(a.Item,{name:"description",label:"描述",rules:[{max:200,message:"描述不能超过200个字符"}],children:t.jsx(K,{placeholder:"请输入API Key描述（可选）",rows:3})}),t.jsx(a.Item,{name:"expires_at",label:"过期时间",help:"留空表示永不过期",children:t.jsx(m,{style:{width:"100%"},placeholder:"选择过期时间（可选）",disabledDate:e=>e&&e<i().endOf("day")})}),t.jsx(a.Item,{style:{marginBottom:0,textAlign:"right"},children:t.jsxs(c,{children:[t.jsx(x,{onClick:()=>{D(!1),M(null),$.resetFields()},children:"取消"}),t.jsx(x,{type:"primary",htmlType:"submit",children:F?"更新":"创建"})]})})]})})]})};export{b as default};
